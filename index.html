<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity WebGL Player | adena-game-main-2022</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
  <style>
    /* [FIX] Ensure the game fills the entire iframe without scrollbars */
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      /* Prevent ANY scrollbars */
      background: #000;
    }

    #unity-container {
      width: 100% !important;
      height: 100% !important;
      position: relative !important;
      left: 0 !important;
      top: 0 !important;
      transform: none !important;
    }

    #unity-canvas {
      width: 100% !important;
      height: 100% !important;
    }

    #unity-footer {
      display: none !important;
      /* Hide footer to maximize game space */
    }
  </style>
</head>

<body>
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"> </div>
    <div id="unity-footer">
      <div id="unity-webgl-logo"></div>
      <div id="unity-fullscreen-button"></div>
      <div id="unity-build-title">adena-game-main-2022</div>
    </div>
  </div>
  <script>
    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");
    var fullscreenButton = document.querySelector("#unity-fullscreen-button");
    var warningBanner = document.querySelector("#unity-warning");

    // [BRIDGE] Dispatch event to the extension (Parent window)
    window.dispatchReactUnityEvent = function (eventName) {
      console.log("[Bridge] Dispatching signal to Parent Overlay:", eventName);
      try {
        var customEvent = new CustomEvent("ReactUnityEvent", {
          detail: { eventName: eventName, data: arguments[1] || null }
        });
        window.dispatchEvent(customEvent);

        var msgType = eventName.startsWith("On") ? eventName.substring(2) : eventName;

        window.parent.postMessage({
          type: msgType,
          data: arguments[1] || null
        }, "*");
      } catch (e) {
        console.warn("[Bridge] Signal dispatch failed", e);
      }
    };

    // [BRIDGE] Receive events from Extension and relay to Unity Engine
    window.addEventListener("message", function (event) {
      if (!event.data || !window.unityInstance) return;

      // [HYBRID FIX] Support both Old (AdenaAuthSuccess) and New (SetUserIdentity) protocols
      if (event.data.type === "AdenaAuthSuccess") {
        console.log("[Bridge] LEGACY AUTH RECEIVED:", event.data.userInfo);
        window.unityInstance.SendMessage("WebGLConnection", "OnTwitterConnected", JSON.stringify(event.data.userInfo));
      }
      else if (event.data.type === "UNITY_EVENT" && event.data.eventName === "SetUserIdentity") {
        console.log("[Bridge] MODERN AUTH RECEIVED:", event.data.arg);

        // [FIX] Sanitize Data & Force Strict JSON Structure
        var raw = event.data.arg || {};
        var safeData = {
          id: (raw.id || raw.twitter_id || "").toString(),
          username: (raw.username || raw.handle || "").toString(),
          name: (raw.name || raw.username || "Player").toString()
        };

        var jsonStr = JSON.stringify(safeData);
        console.log("[Bridge] Sending Clean JSON:", jsonStr);

        window.unityInstance.SendMessage("WebGLConnection", "OnTwitterConnected", jsonStr);
      }
      else if (event.data.type === "AdenaJoinServer") {
        console.log("[Bridge] JOIN RECEIVED:", event.data.code);
        window.unityInstance.SendMessage("WebGLConnection", "OnJoinServer", event.data.code);
      }
    });

    function unityShowBanner(msg, type) {
      function updateBannerVisibility() {
        warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
      }
      var div = document.createElement('div');
      div.innerHTML = msg;
      warningBanner.appendChild(div);
      if (type == 'error') div.style = 'background: red; padding: 10px;';
      else {
        if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
        setTimeout(function () {
          warningBanner.removeChild(div);
          updateBannerVisibility();
        }, 5000);
      }
      updateBannerVisibility();
    }

    var buildUrl = "Build";
    var loaderUrl = buildUrl + "/Build.loader.js";
    var config = {
      dataUrl: buildUrl + "/Build.data",
      frameworkUrl: buildUrl + "/Build.framework.js",
      codeUrl: buildUrl + "/Build.wasm",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "adena-game-main-2022",
      productVersion: "1.0",
      showBanner: unityShowBanner,
    };

    // [FIXED] Force 100% fit for both Mobile and Desktop

    loadingBar.style.display = "block";

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        progressBarFull.style.width = 100 * progress + "%";
      }).then((unityInstance) => {
        loadingBar.style.display = "none";
        window.unityInstance = unityInstance;

        // [CRITICAL] Synchronize with Extension immediately after loader completes
        console.log("[Bridge] Unity Ready. Dispatching Handshake Signal...");
        window.dispatchReactUnityEvent("OnUnityReady");

        fullscreenButton.onclick = () => {
          unityInstance.SetFullscreen(1);
        };
      }).catch((message) => {
        alert(message);
      });
    };
    document.body.appendChild(script);
  </script>
</body>

</html>